# Fuwa - Self-hosted Discord Alternative

## Architecture Overview

Fuwa is a Go-based self-hosted Discord alternative with a monorepo structure using Go workspaces. The main server implementation lives in `/server/` with a clean separation between configuration, database access, and server logic.

### Key Components

- **Go Workspace**: Uses `go.work` for workspace management - all Go commands should be run from the workspace root
- **Server Package**: Core server logic in `/server/server.go` with minimal structure (currently skeletal)
- **Config System**: Sophisticated environment-based configuration in `/server/config.go` with dual sourcing (.env files + environment variables)
- **Database Layer**: Uses sqlc for type-safe SQL query generation with SQLite backend

## Database Architecture

The project uses **sqlc** (SQL Compiler) for database operations - this is critical to understand:

- **Schema**: Migration files in `/server/database/migrations/` using goose format (`-- +goose Up/Down`)
- **Queries**: SQL queries in `/server/database/queries/` with sqlc annotations (`-- name: QueryName :many`)
- **Generated Code**: Never edit files in `/server/database/` except `queries/` and `migrations/` - all `.go` files are generated by sqlc

### Database Workflow
1. Add migrations to `/server/database/migrations/YYYYMMDDHHMMSS_description.sql`
2. Write queries in `/server/database/queries/*.sql` using sqlc syntax
3. Run `sqlc generate` from `/server/` to regenerate Go code
4. Generated files provide type-safe database access through `database.Queries` struct

## Configuration Patterns

The config system has a specific precedence order (study `/server/config.go`):
1. Default values in `LoadConfig()`
2. `.env` file variables (custom parser, not using external libs)
3. `FUWA_*` environment variables override everything

### Environment Variables
All config uses `FUWA_` prefix:
- `FUWA_DATA_PATH` - Data directory (defaults to `~/.fuwa`)
- `FUWA_PORT` - Server port (default: 8080)
- `FUWA_HOST` - Host address (default: localhost)
- `FUWA_DATABASE_URL` - Database connection string
- `FUWA_JWT_SECRET` - Required in production
- `FUWA_ENVIRONMENT` - Environment mode
- `FUWA_LOG_LEVEL` - Logging verbosity
- `FUWA_ALLOWED_ORIGINS` - CORS origins

## Development Workflow

### Essential Commands
```bash
# From workspace root (/home/shixzie/code/waifu-devs/fuwa/)
cd server && sqlc generate    # Regenerate database code after schema/query changes
go run ./server/cmd/main.go   # Run server (currently empty main)
```

### Code Generation Dependencies
- **sqlc**: Install with `go install github.com/sqlc-dev/sqlc/cmd/sqlc@latest`
- Configuration in `/server/sqlc.yaml` - SQLite engine, generates JSON tags

## Project Conventions

1. **Package Structure**: Clean separation - `server` package for core logic, `database` package for data access
2. **Error Handling**: Config validation includes detailed error messages with context
3. **Generated Code**: Strong convention - never manually edit generated files, always regenerate
4. **Environment Flexibility**: Dual .env file + environment variable support for different deployment scenarios
5. **Database Migrations**: Use timestamp-based naming for migrations with descriptive names

## Current State & Next Steps

The project is in early development:
- Basic config system and database layer established
- Server struct exists but `Start()` method is empty
- Main function is placeholder
- No HTTP routing, authentication, or core Discord-like features yet

When adding features, follow the established patterns:
- Extend `Server` struct for new capabilities
- Add database schemas via migrations + sqlc queries
- Configuration through the established `FUWA_*` environment variable system
- Maintain the clean package separation between server logic and database access
